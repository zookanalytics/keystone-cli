$schema: https://raw.githubusercontent.com/mhingston/keystone-cli/main/schemas/workflow.json
name: scaffold-feature
description: "Autonomously build new Keystone workflows and agents"

steps:
  - id: get_requirements
    type: human
    message: "Describe the workflow you want to build:"
    inputType: text

  - id: blueprint
    type: blueprint
    needs: [get_requirements]
    agent: keystone-architect
    prompt: |
      Generate a system blueprint for the following requirements:
      ${{ steps.get_requirements.output }}

  - id: plan
    type: workflow
    needs: [blueprint]
    path: scaffold-plan
    inputs:
      requirements: ${{ steps.get_requirements.output }}
      blueprint: ${{ steps.blueprint.output }}
    outputMapping:
      files: files

  - id: generate
    type: workflow
    needs: [blueprint, plan]
    path: scaffold-generate
    inputs:
      requirements: ${{ steps.get_requirements.output }}
      blueprint: ${{ steps.blueprint.output }}
      files: ${{ steps.plan.outputs.files }}
    outputMapping:
      files: files

  - id: write_files
    type: file
    needs: [generate]
    foreach: ${{ steps.generate.outputs.files }}
    op: write
    path: ${{ item.path }}
    content: ${{ item.content }}

  - id: summary
    type: shell
    needs: [write_files]
    run: |
      echo "Scaffolding complete. Files created:"
      echo "${{ steps.generate.outputs && steps.generate.outputs.files ? steps.generate.outputs.files.map(f => f.path).join('\n') : '(dry run: no files generated)' }}"
