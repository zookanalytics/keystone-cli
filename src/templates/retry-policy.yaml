$schema: https://raw.githubusercontent.com/mhingston/keystone-cli/main/schemas/workflow.json
name: retry-policy
description: "Test retry and timeout features"

steps:
  # Test retry with a command that fails first few times
  - id: flaky_command
    type: shell
    run: |
      if [ ! -f /tmp/keystone-retry-test ]; then
        echo "1" > /tmp/keystone-retry-test
        exit 1
      else
        count=$(cat /tmp/keystone-retry-test)
        count=$((count + 1))
        echo $count > /tmp/keystone-retry-test
        if [ $count -lt 3 ]; then
          exit 1
        fi
        echo "Success after $count attempts"
      fi
    retry:
      count: 3
      backoff: exponential

  # Test timeout (should complete before timeout)
  - id: quick_task
    type: shell
    run: sleep 0.1 && echo "Completed"
    timeout: 5000
    needs: [flaky_command]

  # Cleanup
  - id: cleanup
    type: shell
    run: rm -f /tmp/keystone-retry-test
    needs: [quick_task]
