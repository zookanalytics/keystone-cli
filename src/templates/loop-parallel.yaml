name: loop-parallel
description: "Test the foreach race condition fix and .every() support"

outputs:
  all_success: ${{ steps.process_items.items.every(s => s.status == 'success') }}
  item_count: ${{ steps.process_items.outputs.length }}
  first_output: ${{ steps.process_items.items[0].output }}

steps:
  # Generate test data
  - id: generate_items
    type: shell
    run: "echo 'item1\nitem2\nitem3\nitem4\nitem5'"
    transform: "stdout.split('\\n').filter(Boolean)"

  # Process items with concurrency (tests race condition fix)
  - id: process_items
    type: shell
    needs: [generate_items]
    foreach: ${{ steps.generate_items.output }}
    concurrency: 3
    run: "echo 'Processing: ${{ item }}' && sleep 0.1"
    transform: "stdout.trim()"

  # Test conditional using .every() (tests aggregation fix)
  - id: success_notification
    type: shell
    needs: [process_items]
    if: ${{ steps.process_items.items.every(s => s.status == 'success') }}
    run: "echo 'All items processed successfully!'"

  # Test accessing individual item status
  - id: check_first
    type: shell
    needs: [process_items]
    if: ${{ steps.process_items.items[0].status == 'success' }}
    run: "echo 'First item was successful'"
